name: Deploy Backend to Server - Direct

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'production'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-server-direct.yml'
      - 'core/auth_middleware.py'

jobs:
  deploy-server:
    name: ğŸš€ Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Create deployment script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        echo "ğŸ”„ Stopping existing backend..."
        pkill -f "python3 app.py" || true
        sleep 3
        
        echo "ğŸ“¥ Updating code..."
        cd thakii-backend-api
        git fetch origin
        git reset --hard origin/main
        git pull origin main
        
        echo "ğŸ”§ Installing dependencies..."
        source venv/bin/activate
        pip install -r requirements.txt
        pip install PyJWT requests
        
        echo "ğŸ”§ Configuring environment..."
        cat > .env << 'ENVEOF'
        # Flask Configuration
        FLASK_ENV=production
        FLASK_DEBUG=False
        PORT=5001
        
        # AWS Configuration
        AWS_DEFAULT_REGION=us-east-2
        S3_BUCKET_NAME=thakii-video-storage-1753883631
        
        # Firebase Configuration (ENABLED with JWKS fallback)
        GOOGLE_CLOUD_PROJECT=thakii-973e3
        FIREBASE_PROJECT_ID=thakii-973e3
        
        # CORS Configuration
        ALLOWED_ORIGINS=https://thakii-frontend.netlify.app
        
        # Mock Authentication for E2E Testing
        STATIC_BEARER_TOKEN=thakii-mock-prod-token
        STATIC_BEARER_EMAIL=mock.admin@thakii.test
        STATIC_BEARER_NAME=Mock Admin User
        STATIC_BEARER_UID=static-mock-admin
        STATIC_BEARER_IS_ADMIN=true
        
        # Custom Token Configuration
        CUSTOM_TOKEN_SECRET=thakii-custom-secret-key-2025
        ENVEOF
        
        echo "ğŸš€ Starting backend..."
        source venv/bin/activate
        source .env
        mkdir -p logs
        nohup python3 app.py > logs/backend-jwks.log 2>&1 &
        echo $! > backend.pid
        
        echo "â³ Waiting for startup..."
        sleep 10
        
        echo "ğŸ¥ Testing health..."
        curl -f http://127.0.0.1:5001/health || echo "Health check failed"
        
        echo "ğŸ” Testing auth with invalid token..."
        curl -H "Authorization: Bearer invalid-token" http://127.0.0.1:5001/list
        
        echo "âœ… Deployment complete"
        EOF
        
        chmod +x deploy.sh
        
    - name: ğŸš€ Deploy via curl (bypassing SSH)
      run: |
        echo "This is a placeholder - the actual deployment would need SSH access"
        echo "The deployment script has been created and would be executed on the server"
        echo "Manual step: Copy deploy.sh to server and execute it"
        
    - name: ğŸ“Š Show deployment script
      run: |
        echo "=== Deployment Script ==="
        cat deploy.sh
